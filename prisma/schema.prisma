generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  player
  mod
  dev
  manager
  admin
  superadmin
}

enum OrderStatus {
  pending
  completed
  failed
  refunded
}

enum ServerStatus {
  running
  stopped
  starting
  error
}

enum ServerType {
  paper
  purpur
}

enum ApplicationStatus {
  pending
  accepted
  rejected
  interview
}

enum LogLevel {
  info
  warn
  error
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  password      String
  uuid          String?   @unique
  role          UserRole  @default(player)
  reputation    Int       @default(0)
  twoFactorSecret String?
  twoFactorEnabled Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  orders        Order[]
  votes         Vote[]
  staffApplications StaffApplication[]
  logs          Log[]

  @@map("users")
}

model Server {
  id            String       @id @default(uuid())
  name          String       @unique
  type          ServerType   @default(paper)
  version       String       @default("1.21.4")
  status        ServerStatus @default(stopped)
  port          Int          @unique
  ram           Int          @default(4)
  maxPlayers    Int          @default(100)
  containerId   String?
  nodeId        String?

  node          ServerNode?  @relation(fields: [nodeId], references: [id])
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("servers")
}

model ServerNode {
  id            String   @id @default(uuid())
  name          String   @unique
  host          String
  port          Int      @default(2376)
  maxRam        Int      @default(32)
  maxServers    Int      @default(10)
  isOnline      Boolean  @default(true)
  createdAt     DateTime @default(now())

  servers       Server[]

  @@map("server_nodes")
}

model Order {
  id              String      @id @default(uuid())
  userId          String
  items           Json
  total           Float
  status          OrderStatus @default(pending)
  stripeSessionId String?     @unique
  stripePaymentId String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user            User        @relation(fields: [userId], references: [id])

  @@map("orders")
}

model Vote {
  id            String   @id @default(uuid())
  userId        String
  site          String
  rewardClaimed Boolean  @default(false)
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id])

  @@map("votes")
}

model StaffApplication {
  id            String            @id @default(uuid())
  userId        String
  username      String
  age           Int
  discord       String
  experience    String            @db.Text
  motivation    String            @db.Text
  availability  String            @db.Text
  skills        String?           @db.Text
  score         Int               @default(0)
  status        ApplicationStatus @default(pending)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user          User              @relation(fields: [userId], references: [id])

  @@map("staff_applications")
}

model Log {
  id        String   @id @default(uuid())
  action    String
  userId    String?
  details   String   @db.Text
  level     LogLevel @default(info)
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id])

  @@map("logs")
}

model WebhookLog {
  id        String   @id @default(uuid())
  type      String
  payload   Json
  status    Int
  response  String?  @db.Text
  createdAt DateTime @default(now())

  @@map("webhook_logs")
}

// ============ NEXABOT TABLES ============

model Ticket {
  id            String      @id @default(uuid())
  userId        String
  channelId     String      @unique
  category      String
  subject       String?
  status        TicketStatus @default(open)
  priority      TicketPriority @default(normal)
  createdAt     DateTime    @default(now())
  closedAt      DateTime?
  closedBy      String?

  messages      TicketMessage[]

  @@map("tickets")
}

enum TicketStatus {
  open
  pending
  closed
}

enum TicketPriority {
  low
  normal
  high
  urgent
}

model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  authorId    String
  authorName  String
  content     String   @db.Text
  isStaff     Boolean  @default(false)
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
}

model Warning {
  id          String   @id @default(uuid())
  userId      String
  discordId   String?
  type        WarningType
  reason      String   @db.Text
  duration    String?
  expiresAt   DateTime?
  issuedBy    String
  issuedAt    DateTime @default(now())
  active      Boolean  @default(true)

  @@map("warnings")
}

enum WarningType {
  warn
  mute
  kick
  ban
  tempban
}

model Reputation {
  id          String   @id @default(uuid())
  userId      String   @unique
  username    String   @unique
  points      Int      @default(0)
  positive    Int      @default(0)
  negative    Int      @default(0)
  totalGiven  Int      @default(0)
  lastUpdated DateTime @default(now())

  history     ReputationHistory[]

  @@map("reputations")
}

model ReputationHistory {
  id          String   @id @default(uuid())
  userId      String
  amount      Int
  reason      String   @db.Text
  givenBy     String
  type        RepType
  createdAt   DateTime @default(now())

  user        Reputation @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("reputation_history")
}

enum RepType {
  positive
  negative
}

model ServerControl {
  id          String   @id @default(uuid())
  serverId    String
  action      String
  performedBy String
  success     Boolean  @default(true)
  output      String?  @db.Text
  createdAt   DateTime @default(now())

  @@map("server_controls")
}

model RecruitmentScore {
  id          String   @id @default(uuid())
  userId      String
  username    String
  discordId   String
  score       Int      @default(0)
  criteria1   Int      @default(0)
  criteria2   Int      @default(0)
  criteria3   Int      @default(0)
  criteria4   Int      @default(0)
  criteria5   Int      @default(0)
  totalScore  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("recruitment_scores")
}
